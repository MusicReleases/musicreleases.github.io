var w=(e,r)=>r.some(t=>e instanceof t),b,p;function v(){return b||(b=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function M(){return p||(p=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var D=new WeakMap,m=new WeakMap,y=new WeakMap;function L(e){let r=new Promise((t,o)=>{let n=()=>{e.removeEventListener("success",c),e.removeEventListener("error",s)},c=()=>{t(l(e.result)),n()},s=()=>{o(e.error),n()};e.addEventListener("success",c),e.addEventListener("error",s)});return y.set(r,e),r}function O(e){if(D.has(e))return;let r=new Promise((t,o)=>{let n=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",s),e.removeEventListener("abort",s)},c=()=>{t(),n()},s=()=>{o(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",c),e.addEventListener("error",s),e.addEventListener("abort",s)});D.set(e,r)}var N={get(e,r,t){if(e instanceof IDBTransaction){if(r==="done")return D.get(e);if(r==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return l(e[r])},set(e,r,t){return e[r]=t,!0},has(e,r){return e instanceof IDBTransaction&&(r==="done"||r==="store")?!0:r in e}};function S(e){N=e(N)}function j(e){return M().includes(e)?function(...r){return e.apply(g(this),r),l(this.request)}:function(...r){return l(e.apply(g(this),r))}}function I(e){return typeof e=="function"?j(e):(e instanceof IDBTransaction&&O(e),w(e,v())?new Proxy(e,N):e)}function l(e){if(e instanceof IDBRequest)return L(e);if(m.has(e))return m.get(e);let r=I(e);return r!==e&&(m.set(e,r),y.set(r,e)),r}var g=e=>y.get(e);function k(e,r,{blocked:t,upgrade:o,blocking:n,terminated:c}={}){let s=indexedDB.open(e,r),f=l(s);return o&&s.addEventListener("upgradeneeded",i=>{o(l(s.result),i.oldVersion,i.newVersion,l(s.transaction),i)}),t&&s.addEventListener("blocked",i=>t(i.oldVersion,i.newVersion,i)),f.then(i=>{c&&i.addEventListener("close",()=>c()),n&&i.addEventListener("versionchange",d=>n(d.oldVersion,d.newVersion,d))}).catch(()=>{}),f}function V(e,{blocked:r}={}){let t=indexedDB.deleteDatabase(e);return r&&t.addEventListener("blocked",o=>r(o.oldVersion,o)),l(t).then(()=>{})}var A=["get","getKey","getAll","getAllKeys","count"],K=["put","add","delete","clear"],h=new Map;function P(e,r){if(!(e instanceof IDBDatabase&&!(r in e)&&typeof r=="string"))return;if(h.get(r))return h.get(r);let t=r.replace(/FromIndex$/,""),o=r!==t,n=K.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(n||A.includes(t)))return;let c=async function(s,...f){let i=this.transaction(s,n?"readwrite":"readonly"),d=i.store;return o&&(d=d.index(f.shift())),(await Promise.all([d[t](...f),n&&i.done]))[0]};return h.set(r,c),c}S(e=>({...e,get:(r,t,o)=>P(r,t)||e.get(r,t,o),has:(r,t)=>!!P(r,t)||e.has(r,t)}));var T=["continue","continuePrimaryKey","advance"],x={},B=new WeakMap,E=new WeakMap,W={get(e,r){if(!T.includes(r))return e[r];let t=x[r];return t||(t=x[r]=function(...o){B.set(this,E.get(this)[r](...o))}),t}};async function*F(...e){let r=this;if(r instanceof IDBCursor||(r=await r.openCursor(...e)),!r)return;r=r;let t=new Proxy(r,W);for(E.set(t,r),y.set(t,g(r));r;)yield t,r=await(B.get(t)||r.continue()),B.delete(t)}function C(e,r){return r===Symbol.asyncIterator&&w(e,[IDBIndex,IDBObjectStore,IDBCursor])||r==="iterate"&&w(e,[IDBIndex,IDBObjectStore])}S(e=>({...e,get(r,t,o){return C(r,t)?F:e.get(r,t,o)},has(r,t){return C(r,t)||e.has(r,t)}}));var a={};async function u(e){e.version===null&&(e.version=void 0),e.keyPath??="id";try{return await k(e.databaseName,e.version,{upgrade(t){if(e.storeNames)for(let o of e.storeNames)t.objectStoreNames.contains(o)||t.createObjectStore(o,{keyPath:e.keyPath});t.objectStoreNames.length==0&&!t.objectStoreNames.contains(e.databaseName)&&t.createObjectStore(e.databaseName,{keyPath:e.keyPath})}})}catch(r){return console.error(r),null}}async function z(e){let r=await u(e);if(r)try{return await r.clear(e.storeName??e.databaseName)}catch(t){console.error(t)}}async function G(e){let r=await u(e);if(!r)return 0;try{return await r.count(e.storeName??e.databaseName)}catch(t){return console.error(t),0}}async function H(e){try{await V(e)}catch(r){console.error(r)}}async function Q(e,r){let t=await u(e);if(!t)return!1;try{return await t.delete(e.storeName??e.databaseName,r),!0}catch(o){return console.error(o),!1}}async function U(e){let r=await u(e);if(!r)return[];try{return await r.getAll(e.storeName??e.databaseName)}catch(t){return console.error(t),[]}}async function X(e){let r=await u(e);if(!r)return[];try{var t=await r.getAll(e.storeName??e.databaseName);return t.map(o=>JSON.stringify(o))}catch(o){return console.error(o),[]}}async function Y(e,r){let t=await u(e);if(!t)return[];let o=e.databaseName+"."+e.storeName;r&&delete a[o];let n=a[o];if(!n||n.db.version!=e.version)try{let s=await t.transaction(e.storeName??e.databaseName).store.openCursor();n={db:e,cursor:s}}catch(s){console.error(s)}else try{n.cursor=await t.transaction(e.storeName??e.databaseName).store.openCursor(),n.cursor&&n.key&&(n.cursor=await n.cursor.continue(n.key))}catch(s){console.error(s)}if(!n||!n.cursor)return delete a[o],[];let c=[];try{for(;n.cursor&&c.length<20;)if(c.push(n.cursor.value),n.cursor=await n.cursor.continue(),n.cursor)n.key=n.cursor.key;else return delete a[o],c}catch(s){console.error(s)}return a[o]=n,c}async function Z(e,r){let t=await u(e);if(!t)return[];let o=e.databaseName+"."+e.storeName;r&&delete a[o];let n=a[o];if(!n||n.db.version!=e.version)try{let s=await t.transaction(e.storeName??e.databaseName).store.openCursor();n={db:e,cursor:s}}catch(s){console.error(s)}else try{n.cursor=await t.transaction(e.storeName??e.databaseName).store.openCursor(),n.cursor&&n.key&&(n.cursor=await n.cursor.continue(n.key))}catch(s){console.error(s)}if(!n||!n.cursor)return delete a[o],[];let c=[];try{for(;n.cursor&&c.length<20;)if(c.push(JSON.stringify(n.cursor.value)),n.cursor=await n.cursor.continue(),n.cursor)n.key=n.cursor.key;else return delete a[o],c}catch(s){console.error(s)}return a[o]=n,c}async function _(e,r){let t=await u(e);if(!t)return null;try{return await t.get(e.storeName??e.databaseName,r)}catch(o){return console.error(o),null}}async function q(e,r){let t=await u(e);if(!t)return null;try{return JSON.stringify(await t.get(e.storeName??e.databaseName,r))}catch(o){return console.error(o),null}}async function ee(e,r){let t=await u(e);if(!t)return!1;try{return await t.put(e.storeName??e.databaseName,JSON.parse(r)),!0}catch(o){return console.error(o),!1}}export{z as clear,G as count,H as deleteDatabase,Q as deleteValue,U as getAll,X as getAllStrings,Y as getBatch,Z as getBatchStrings,_ as getValue,q as getValueString,ee as putValue};
//# sourceMappingURL=tavenem-indexeddb.js.map
